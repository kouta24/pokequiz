<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ポケモンモザイククイズ</title>
  <link href="https://fonts.googleapis.com/earlyaccess/nicomoji.css" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background-color: #333333;
      color: #ffffff;
      margin: 20;
      font-size: 16px; 
      justify-content: center;
    }
    /* タイトル */
    h1 {
      font-family: "Nico Moji";
      font-size: 36px; /* スケーラブル */
      font-weight: 600;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      margin-bottom: 1vmin;
    }

    #canvas {
      border: 2px solid #ffffff;
      margin: 20px auto;
      display: none;
      max-width: 100%;
      background-color: #000000;
    }
    #timerBarContainer {
      margin: 1em auto 0 auto;
      height: 10px;
      width: 90vw; /* ビューポート幅の90% */
      max-width: 800px; /* キャンバス幅を上限 */
      min-width: 300px; /* 最小幅を保証 */
      background-color: #cccccc;
      border-radius: 10px;
      overflow: hidden;
      display: none;
    }
    #timerBar {
      height: 100%;
      width: 100%;
      background-color: #4CAF50;
      transition: width 0.1s linear, background-color 0.3s;
    }
    #timerBar.red {
        background-color: #f44336;
    }
    #controls {
      margin: 20px;
      display: none;
    }
    #stats {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      flex-wrap: nowrap; /* 改行を禁止 */
    }
    #startButton, #resetButton, #infoButton, .region-select-button {
      padding: 8px;
      font-size: 16px;
      font-weight: bold;
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      transition: all 0.2s ease;
      width: 220px;
      margin: 10px auto;
      display: block;
    }
    #startButton {
      background-color: #4CAF50;
      padding: 12px;
      font-size: 18px;
    }
    #startButton:hover:not(:disabled) {
      background-color: #45a049;
      transform: scale(1.05);
    }
    #startButton:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    #resetButton {
      background-color: #f44336;
      padding: 12px;
      font-size: 18px;
      display: none;
    }
    #resetButton:hover:not(:disabled) {
      background-color: #d32f2f;
      transform: scale(1.05);
    }
    #resetButton:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
      opacity: 0.6;
    }
    #infoButton, .region-select-button {
      margin: 5px auto;
    }
    #infoButton:hover, .region-select-button:hover {
      background-color: #1e88e5;
      transform: scale(1.05);
    }
    .choiceButton {
      padding: 8px;
      font-size: 16px;
      font-weight: bold;
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      width: 380px;
      margin: 5px;
    }
    #submitAnswerButton {
      padding: 8px;
      font-size: 16px;
      font-weight: bold;
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      width: 160px;
      margin: 5px;
    }

    .hintButton, #playCryButton {
      padding: 8px;
      font-size: 16px;
      font-weight: bold;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      width: 180px;
      margin: 5px;
    }

    .choiceButton:hover:not(:disabled), #submitAnswerButton:hover:not(:disabled){
      background-color: #1e88e5;
      transform: scale(1.05);
    }
    .hintButton:hover:not(:disabled), #playCryButton:hover:not(:disabled) {
      background-color: #4CAF50;
      transform: scale(1.05);
    }
    .hintButton:disabled, #playCryButton:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    #choices {
      display: grid;
      grid-template-columns: repeat(2, 390px);
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    #answerInput {
      padding: 8px;
      font-size: 16px;
      width: 220px;
      margin: 5px;
      border-radius: 4px;
      border: 1px solid #ccc;
      position: relative;
    }
    .input-button-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin: 10px auto;
      position: relative;
    }
    .checkbox-container {
      margin-top: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
    }
    #volumeControl {
      width: 100px;
      margin: 5px;
      vertical-align: middle;
      -webkit-appearance: none;
      appearance: none;
      height: 8px;
      background: #ffffff;
      border-radius: 4px;
      outline: none;
      cursor: pointer;
    }
    #volumeControl::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      background: #2196F3;
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.2s;
    }
    #volumeControl::-webkit-slider-thumb:hover {
      background: #1e88e5;
    }
    #volumeControl::-moz-range-track {
      height: 8px;
      background: #444;
      border-radius: 4px;
    }
    #volumeControl::-moz-range-thumb {
      width: 16px;
      height: 16px;
      background: #2196F3;
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.2s;
    }
    #volumeControl::-moz-range-thumb:hover {
      background: #1e88e5;
    }
    .autocomplete-dropdown {
      position: absolute;
      width: 220px;
      background-color: #424242;
      border: 1px solid #ffffff;
      border-radius: 4px;
      max-height: 150px;
      overflow-y: auto;
      z-index: 10;
      display: none;
      text-align: left;
      font-size: 14px;
    }
    .autocomplete-item {
      padding: 8px;
      cursor: pointer;
      color: #ffffff;
    }
    .autocomplete-item:hover {
      background-color: #2196F3;
    }
    .hint-button-container, .cry-button-container {
      margin-top: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }
    #score, #correctAnswers, #question, #hpDisplay {
      font-size: 16px;
      font-weight: bold;
      color: #ffffff;
      display: none;
      line-height: 1.5;
      white-space: nowrap; 
    }
    #result {
      margin-top: 20px;
      font-weight: bold;
      font-size: 18px;
      color: #ffffff;
    }
    .answer-text {
      font-size: 22px;
      text-decoration: underline;
    }
    .toggle-container, .hard-mode-toggle, .hint-toggle, .nightmare-toggle, .panel-mode-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-top: 10px;
      gap: 8px;
    }
    .hint-toggle {
      margin-bottom: 16px;
    }
    .nightmare-toggle select, .nightmare-toggle span {
      vertical-align: middle;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 28px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 28px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #2196F3;
    }
    input:checked + .slider:before {
      transform: translateX(22px);
    }
    .tooltip {
      display: none;
      position: absolute;
      right: calc(100% + 10px);
      top: 50%;
      transform: translateY(-50%);
      background-color: #424242;
      color: #ffffff;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      white-space: nowrap;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      z-index: 10;
    }
    .toggle-container:hover .tooltip, .hard-mode-toggle:hover .tooltip, .hint-toggle:hover .tooltip, .nightmare-toggle:hover .tooltip, .panel-mode-toggle:hover .tooltip {
      display: block;
    }
    #settings {
      margin: 20px auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    .settings-panel {
      font-family: "Nico Moji";
      background-color: #424242;
      border: 2px solid #ffffff;
      border-radius: 12px;
      padding: 20px;
      max-width: 380px;
      width: 80%;
      margin: 0 auto;
    }
    #questionCount{
      padding: 8px;
      font-size: 16px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background-color: #ffffff;
      color: #333333;
      width: 140px;
    }
    #hintCount{
      padding: 8px;
      font-size: 16px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background-color: #ffffff;
      color: #333333;
      width: 70px;
    }
    #hpCount {
      padding: 8px;
      font-size: 16px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background-color: #ffffff;
      color: #333333;
      width: 60px;
    }
    .radio-group {
      display: flex;
      gap: 20px;
      justify-content: center;
    }
    .region-select-container {
      position: relative;
      margin-top: 10px;
      width: 220px;
    }
    .region-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      width: 220px;
      background-color: #424242;
      border: 1px solid #ffffff;
      border-radius: 8px;
      padding: 10px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 10;
    }
    .region-checkbox {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      font-size: 16px;
    }
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: #424242;
      border: 2px solid #ffffff;
      border-radius: 12px;
      padding: 20px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      color: #ffffff;
      font-size: 18px;
      text-align: left;
      position: relative;
    }
    .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      color: #ffffff;
      background-color: #f44336;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      line-height: 40px;
      text-align: center;
      transition: background-color 0.2s;
    }
    .modal-close:hover {
      background-color: #d32f2f;
    }
    .result-title, .info-title {
      font-family: "Nico Moji";
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 20px;
      text-decoration: underline;
      text-align: center;
    }
    .result-stats {
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 20px;
    }
    .stat-item {
      display: flex;
      justify-content: space-between;
      width: 450px;
      margin-bottom: 12px;
      font-size: 20px;
      line-height: 24px;
      align-items: center;
    }
    .stat-key {
      flex: 1;
      text-align: right;
      padding-right: 10px;
    }
    .stat-value {
      flex: 1;
      text-align: left;
      padding-left: 10px;
    }
    .stat-colon {
      display: inline-block;
      width: 20px;
      text-align: center;
      font-size: 20px;
      line-height: 24px;
    }
    .mode-info, .hint-info, .quiz-mode-info {
      display: flex;
      justify-content: space-between;
      width: 450px;
      margin-bottom: 12px;
      font-size: 20px;
      line-height: 24px;
      align-items: center;
    }
    .mode-info .stat-key, .hint-info .stat-key, .quiz-mode-info .stat-key {
      text-align: right;
      padding-right: 10px;
    }
    .mode-info .stat-value, .hint-info .stat-value, .quiz-mode-info .stat-value {
      text-align: left;
      padding-left: 10px;
    }
    .result-stats p:not(.congratulation) {
      display: none;
    }
    .result-stats p.congratulation {
      font-size: 20px;
      color: gold;
      margin-top: 12px;
      margin-bottom: 12px;
      font-weight: bold;
    }
    .wrong-answers-header {
      position: sticky;
      top: 0;
      background-color: #424242;
      padding: 10px 0;
      z-index: 1;
      margin: 10px 0;
      text-align: center;
    }
    .wrong-answers-header h3 {
      font-size: 24px;
      margin: 0;
    }
    .wrong-answers {
      text-align: left;
      overflow-x: auto;
      scroll-behavior: smooth;
      padding: 10px 0;
      border-bottom: 1px solid #ffffff;
      white-space: nowrap;
      margin-left: 0;
    }
    .wrong-answers ul {
      display: flex;
      flex-direction: row;
      list-style: none;
      padding: 0;
      margin: 0;
      gap: 15px;
      justify-content: flex-start;
    }
    .wrong-answers li {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 140px;
      font-size: 16px;
      flex-shrink: 0;
    }
    .wrong-answers img {
      width: 100px;
      height: 100px;
      margin-bottom: 10px;
      border: 1px solid #ffffff;
      border-radius: 4px;
    }
    .info-content p {
      margin: 15px 0;
      font-size: 16px;
      line-height: 1.6;
    }
    .info-content h3 {
      font-size: 22px;
      font-weight: bold;
      margin: 20px 0 10px;
      color: #ff7b00;
    }
    .info-content ul {
      list-style: disc;
      padding-left: 25px;
      margin: 10px 0;
      font-size: 16px;
      line-height: 1.6;
    }
    .info-content li {
      margin-bottom: 8px;
    }
    .info-content a {
      color: #1e88e5;
      text-decoration: none;
      font-weight: bold;
    }
    .info-content a:hover {
      text-decoration: underline;
    }
    .info-content .note {
      font-size: 14px;
      color: #bbbbbb;
      margin-top: 20px;
    }
    .info-content .contact {
      margin-top: 30px;
      font-size: 16px;
      line-height: 1.6;
    }
    .info-content .contact h3 {
      text-decoration: underline;
      color: #ffffff;
    }
    @media (max-width: 600px) {
      body { font-size: 14px; }
      #startButton, #resetButton { padding: 10px; font-size: 16px; width: 220px; }
      #infoButton, .region-select-button { font-size: 14px; width: 220px; }
      .choiceButton, #submitAnswerButton { padding: 8px; font-size: 14px; width: 320px; margin: 5px; }
      .hintButton, #playCryButton { padding: 8px; font-size: 14px; width: 160px; margin: 5px; background-color: #4CAF50; }
      #answerInput { font-size: 14px; width: 220px; margin: 5px; }
      .autocomplete-dropdown { width: 220px; }
      .input-button-container, .hint-button-container, .cry-button-container { flex-direction: column; gap: 5px; }
      #stats { flex-direction: row; gap: 10px; flex-wrap: nowrap; /* 改行を禁止 */ }
      #score, #correctAnswers, #question, #hpDisplay { font-size: 12px; white-space: nowrap; }
      #result { font-size: 16px; }
      .answer-text { font-size: 20px; text-decoration: underline; }
      #choices { grid-template-columns: 320px; gap: 5px; max-width: 100%; }
      .modal-content { width: 90%; padding: 15px; font-size: 16px; }
      .result-title { font-size: 24px; }
      .stat-item, .mode-info, .hint-info, .quiz-mode-info { width: 320px; font-size: 18px; line-height: 22px; margin-bottom: 10px; }
      .stat-colon { font-size: 18px; line-height: 22px; }
      .result-stats p.congratulation { font-size: 18px; margin-top: 10px; margin-bottom: 10px; }
      .wrong-answers-header h3 { font-size: 20px; }
      .wrong-answers li { width: 120px; font-size: 14px; }
      .wrong-answers img { width: 80px; height: 80px; }
      .region-select-container, .region-dropdown { width: 220px; }
      .info-content p { font-size: 14px; margin: 12px 0; }
      .info-content h3 { font-size: 20px; }
      .info-content ul { font-size: 14px; padding-left: 20px; }
      .info-content .note { font-size: 12px; }
      .info-content .contact { font-size: 14px; }
      #volumeControl { width: 80px; }
      #volumeControl::-webkit-slider-thumb, #volumeControl::-moz-range-thumb { width: 14px; height: 14px; }
      .modal-close { font-size: 24px; width: 36px; height: 36px; line-height: 36px; }
      #timerBarContainer { width: 90vw; max-width: 100%; min-width: 280px; }
    }
  </style>
</head>
<body>
  <h1>ポケモンモザイククイズ</h1>
  <div id="stats">
    <div id="score">スコア: 0点</div>
    <div id="correctAnswers">正解: 0問</div>
    <div id="question">問題: 0/0</div>
    <div id="hpDisplay">HP: 0/0</div>
  </div>
  <div id="timerBarContainer"><div id="timerBar"></div></div>
  <canvas id="canvas" width="800" height="450"></canvas>
  <div id="controls"></div>
  <div id="result"></div>
  <div id="settings" class="settings-panel">
    <button id="infoButton" onclick="showInfoModal()">ゲーム説明</button>
    <div>
      <label for="questionCount">問題数:</label>
      <select id="questionCount">
        <option value="10">10問</option>
        <option value="20">20問</option>
        <option value="30">30問</option>
        <option value="50">50問</option>
        <option value="all">全問</option>
      </select>
    </div>
    <div class="radio-group">
      <label><input type="radio" name="quizMode" value="multiple" checked> 4択式</label>
      <label><input type="radio" name="quizMode" value="text"> 記入式</label>
    </div>
    <div class="hint-toggle">
      <span>ヒント</span>
      <label class="switch"><input type="checkbox" id="hintToggle"><span class="slider"></span></label>
      <select id="hintCount" style="display: none;"></select>
      <span class="tooltip">有効にすると問題中にヒントを使用できます。</span>
    </div>
    <div class="toggle-container">
      <span>モノクロモード</span>
      <label class="switch"><input type="checkbox" id="modeToggle"><span class="slider"></span></label>
      <span class="tooltip">有効にするとモザイクが白黒で表示されます。</span>
    </div>
    <div class="hard-mode-toggle">
      <span>ハードモード</span>
      <label class="switch"><input type="checkbox" id="hardModeToggle"><span class="slider"></span></label>
      <span class="tooltip">モザイクが時間で変化せず、難易度アップ。</span>
    </div>
    <div class="panel-mode-toggle">
      <span>パネルモード</span>
      <label class="switch"><input type="checkbox" id="panelModeToggle"><span class="slider"></span></label>
      <span class="tooltip">有効にすると画像が9つのパネルで隠され、時間経過でパネルが消えます。</span>
    </div>
    <div class="nightmare-toggle">
      <span>ナイトメアモード</span>
      <label class="switch"><input type="checkbox" id="nightmareToggle"><span class="slider"></span></label>
      <div id="hpCountContainer" style="display: none;">
        <span style="line-height: 34px;">HP:</span>
        <select id="hpCount"></select>
      </div>
      <span class="tooltip">有効にすると不正解でHPが減り、0でゲームオーバーになります。</span>
    </div>
    <div class="region-select-container">
      <button id="regionSelectButton" class="region-select-button">出題地方を選択</button>
      <div id="regionDropdown" class="region-dropdown"></div>
    </div>
  </div>
  <button id="startButton" onclick="startQuiz()">スタート</button>
  <button id="resetButton" onclick="resetQuiz()" disabled>タイトルへ戻る</button>
  <div id="resultModal" class="modal-overlay">
    <div class="modal-content">
      <span class="modal-close" onclick="closeResultModal()">×</span>
      <div class="result-title">リザルト</div>
      <div class="result-stats"></div>
      <div class="wrong-answers-header">
        <h3>間違えたポケモン: <span id="wrongCount">0体</span></h3>
      </div>
      <div class="wrong-answers">
        <ul id="wrongAnswersList"></ul>
      </div>
    </div>
  </div>
  <div id="infoModal" class="modal-overlay">
    <div class="modal-content">
      <span class="modal-close" onclick="closeInfoModal()">×</span>
      <div class="info-title">ゲーム説明</div>
      <div class="info-content">
        <p>モザイクがかかったポケモンの画像を見て、名前を当てるクイズゲームです！</p>
        <h3>[遊び方]</h3>
        <p>時間制限（25秒）内に回答して、高スコアを目指しましょう！<br>回答方法は以下からお好きな方を選択してください。</p>
        <ul>
          <li><strong>4択式</strong> <br>&#009;4つの選択肢から正しいポケモン名を選びます。</li>
          <li><strong>記入式</strong> <br>&#009;ポケモン名を直接入力。頭文字を入力すると候補が表示されます。</li>
        </ul>
        <h3>[ヒント機能]</h3>
        <p>ヒントを有効にすると、以下の情報がランダムで表示されます（回数制限あり）</p>
        <ul>
          <strong>最初の文字、最後の文字、文字数、タイプ、地方</strong>
        </ul>
        <h3>[モード紹介]</h3>
        <ul>
          <li><strong>モノクロモード</strong> <br>&#009;モザイクが白黒になり、難易度が上がります。</li>
          <li><strong>ハードモード</strong> <br>&#009;モザイクが時間経過で変化せず、難易度が上がります。</li>
          <li><strong>パネルモード</strong> <br>&#009;画像が9つのパネルで隠され、時間経過でパネルが消えます。<br>※モザイクは時間で変化しません。</li>
          <li><strong>ナイトメアモード</strong> <br>&#009;不正解でHPが減り、HPが0になるとゲームオーバー。</li>
        </ul>
        <p class="note">※ハードモードとパネルモードを同時に有効にすると、<br>パネルが時間で消えず、鳴き声クイズとして楽しめます。</p>
        <div class="contact">
          <h3>お問い合わせ</h3>
          <p>当サイトは個人が運営するファンサイトであり、<br>株式会社ポケモン様を始めとした公式団体とは一切関係ありません。</p>
          <p><a href="https://twitter.com/kouta24soccer" target="_blank" rel="noopener noreferrer">@kouta24soccer</a><br>何かありましたら上記のX(旧Twitter)アカウントへお問い合わせください。</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    let imageList = [], currentImage = null, pixelSize = 50, animationInterval = null, timerInterval = null;
    let score = 0, correctAnswers = 0, currentQuestion = 0, usedImages = [], selectedQuestions = 10;
    let quizMode = 'multiple', totalQuestions = 0, isMonochrome = false, isHardMode = false;
    let isHintEnabled = false, hintCount = 1, remainingHints = 0, usedHints = [];
    let isQuizStarted = false, isNightmareMode = false, initialHP = 1, currentHP = 0;
    let isPanelMode = false, regions = [], currentStreak = 0, maxStreak = 0, wrongAnswers = [];
    let revealedPanels = [], questionImage = new Image();
    const canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d', { willReadFrequently: true });
    const startButton = document.getElementById('startButton'), resetButton = document.getElementById('resetButton');
    const infoButton = document.getElementById('infoButton'), controls = document.getElementById('controls');
    const scoreDisplay = document.getElementById('score'), correctAnswersDisplay = document.getElementById('correctAnswers');
    const questionDisplay = document.getElementById('question'), hpDisplay = document.getElementById('hpDisplay');
    const timerBarContainer = document.getElementById('timerBarContainer'), timerBar = document.getElementById('timerBar');
    const modeToggle = document.getElementById('modeToggle'), hardModeToggle = document.getElementById('hardModeToggle');
    const hintToggle = document.getElementById('hintToggle'), nightmareToggle = document.getElementById('nightmareToggle');
    const panelModeToggle = document.getElementById('panelModeToggle');
    const questionCount = document.getElementById('questionCount'), hintCountSelect = document.getElementById('hintCount');
    const hpCountSelect = document.getElementById('hpCount'), settings = document.getElementById('settings');
    const regionSelectButton = document.getElementById('regionSelectButton'), regionDropdown = document.getElementById('regionDropdown');
    const resultModal = document.getElementById('resultModal'), infoModal = document.getElementById('infoModal');
    const TIME_LIMIT = 25000;
    let timeRemaining = TIME_LIMIT, cryAudio = new Audio(), cryVolume = 0.05;

    cryAudio.volume = cryVolume;
    questionImage.src = 'images/question.png';

    const GENERATION_ORDER = ['カントー', 'ジョウト', 'ホウエン', 'シンオウ', 'イッシュ', 'カロス', 'アローラ', 'ガラル・ヒスイ', 'パルデア'];

    function calculateModeMultiplier() {
      let multiplier = 1.0;
      if (isMonochrome) multiplier *= 1.2;
      if (isHardMode) multiplier *= 1.4;
      if (isPanelMode) multiplier *= 1.3;
      if (isNightmareMode) multiplier *= 1.1;
      if (quizMode === 'text') multiplier *= 1.5; // 記入式は1.5倍
      return multiplier;
    }

    function calculateStreakBonus() {
      if (currentStreak <= 0) return 0;
      if (currentStreak === 1) return 50;
      if (currentStreak === 2) return 100;
      return 150; // 3回以上は150点で固定
    }

    function initializeHintCountSelect() {
      for (let i = 1; i <= 50; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `${i}回`;
        if (i === 1) option.selected = true;
        hintCountSelect.appendChild(option);
      }
    }

    function initializeHPCountSelect() {
      for (let i = 1; i <= 10; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `${i}`;
        if (i === 1) option.selected = true;
        hpCountSelect.appendChild(option);
      }
    }

    function addEventListenerOnce(element, event, handler) {
      const wrappedHandler = function(e) {
        handler(e);
        element.removeEventListener(event, wrappedHandler);
      };
      element.addEventListener(event, wrappedHandler);
    }

    modeToggle.addEventListener('change', () => { isMonochrome = modeToggle.checked; });
    hardModeToggle.addEventListener('change', () => { isHardMode = hardModeToggle.checked; });
    hintToggle.addEventListener('change', () => {
      isHintEnabled = hintToggle.checked;
      hintCountSelect.style.display = isHintEnabled ? 'inline-block' : 'none';
    });
    nightmareToggle.addEventListener('change', () => {
      isNightmareMode = nightmareToggle.checked;
      hpCountSelect.parentElement.style.display = isNightmareMode ? 'flex' : 'none';
      questionCount.disabled = isNightmareMode;
      if (isNightmareMode) questionCount.value = 'all';
      updateQuestionCountOptions();
    });
    panelModeToggle.addEventListener('change', () => { isPanelMode = panelModeToggle.checked; });
    hintCountSelect.addEventListener('change', () => { hintCount = parseInt(hintCountSelect.value); });
    hpCountSelect.addEventListener('change', () => { initialHP = parseInt(hpCountSelect.value); });
    document.querySelectorAll('input[name="quizMode"]').forEach(radio => {
      radio.addEventListener('change', () => { quizMode = radio.value; });
    });
    regionSelectButton.addEventListener('click', (e) => {
      e.stopPropagation();
      regionDropdown.style.display = regionDropdown.style.display === 'block' ? 'none' : 'block';
    });
    document.addEventListener('click', (e) => {
      if (!regionSelectButton.contains(e.target) && !regionDropdown.contains(e.target)) {
        regionDropdown.style.display = 'none';
      }
      if (!e.target.closest('.input-button-container')) {
        const dropdown = document.querySelector('.autocomplete-dropdown');
        if (dropdown) dropdown.style.display = 'none';
      }
    });

    async function loadQuestionsFromCSV() {
      try {
        const response = await fetch('questions.csv', { cache: 'no-store' });
        if (!response.ok) throw new Error(`CSV読み込み失敗: ${response.status}`);
        const text = await response.text();
        const lines = text.trim().split('\n').slice(1);
        imageList = lines.map(line => {
          const [url, title, pokedex_no = '', type1 = '', type2 = '', region = ''] = line.split(',').map(item => item.trim());
          if (!url || !title) return null;
          const normalizedRegion = region === 'ガラル' || region === 'ヒスイ' ? 'ガラル・ヒスイ' : region;
          return { url, title, pokedex_no, type1, type2, region: normalizedRegion };
        }).filter(item => item);
        updateRegionCheckboxes();
        updateQuestionCountOptions();
      } catch (error) {
        console.error('CSVエラー:', error);
        alert('問題読み込み失敗');
        imageList = [];
        updateRegionCheckboxes();
        updateQuestionCountOptions();
      }
    }

    function updateRegionCheckboxes() {
      const regionCounts = {};
      imageList.forEach(item => {
        const region = item.region || '不明';
        regionCounts[region] = (regionCounts[region] || 0) + 1;
      });
      const availableRegions = [...new Set(imageList.map(item => item.region).filter(r => r))];
      regions = GENERATION_ORDER.filter(region => availableRegions.includes(region));
      availableRegions.forEach(region => { if (!regions.includes(region)) regions.push(region); });
      regionDropdown.innerHTML = '';
      if (!regions.length) {
        regionSelectButton.disabled = true;
        regionSelectButton.textContent = '地方なし';
        return;
      }
      regionSelectButton.disabled = false;
      regionSelectButton.textContent = '出題地方を選択';
      regions.forEach((region, index) => {
        const div = document.createElement('div');
        div.className = 'region-checkbox';
        div.innerHTML = `<input type="checkbox" id="region_${index}" value="${region}" checked><label for="region_${index}">${region} (${regionCounts[region] || 0}種)</label>`;
        regionDropdown.appendChild(div);
        document.getElementById(`region_${index}`).addEventListener('change', updateQuestionCountOptions);
      });
    }

    function updateQuestionCountOptions() {
      const selectedRegions = regions.length ? regions.filter((_, i) => document.getElementById(`region_${i}`)?.checked) : [];
      const filteredQuestions = regions.length ? imageList.filter(item => selectedRegions.includes(item.region) || !item.region) : imageList;
      const allOption = questionCount.querySelector('option[value="all"]');
      const questionCountValue = parseInt(filteredQuestions.length);
      allOption.textContent = `全問 (${questionCountValue}問)`;
      selectedQuestions = questionCount.value === 'all' ? questionCountValue : parseInt(questionCount.value);
      if (parseInt(questionCount.value) > questionCountValue && questionCount.value !== 'all') {
        questionCount.value = questionCountValue.toString();
        selectedQuestions = questionCountValue;
      }
    }

    function showAutocomplete(input) {
      const value = katakanaToHiragana(input.value.trim()).toLowerCase();
      let dropdown = document.querySelector('.autocomplete-dropdown');
      if (!dropdown) {
        dropdown = document.createElement('div');
        dropdown.className = 'autocomplete-dropdown';
        document.body.appendChild(dropdown);
      }
      dropdown.innerHTML = '';
      const inputRect = input.getBoundingClientRect();

      // 候補ドロップダウンの表示位置　修正の余地あり 
      dropdown.style.left = `${inputRect.left}px`;
      if (navigator.userAgent.match(/iPhone|Android.+Mobile/)) {
        //dropdown.style.top = `${inputRect.bottom + 8}px`;
        dropdown.style.top = `${inputRect.left + 8}px`;
      }else{
        dropdown.style.top = `${inputRect.bottom + 8}px`;
      }

      if (value) {
        const selectedRegions = regions.length ? regions.filter((_, i) => document.getElementById(`region_${i}`)?.checked) : [];
        const filteredImageList = regions.length ? imageList.filter(item => selectedRegions.includes(item.region) || !item.region) : imageList;
        const matches = filteredImageList
          .filter(item => katakanaToHiragana(item.title).toLowerCase().startsWith(value))
          .map(item => item.title)
          .slice(0, 10);
        matches.forEach(title => {
          const item = document.createElement('div');
          item.className = 'autocomplete-item';
          item.textContent = title;
          item.onclick = () => {
            input.value = title;
            dropdown.style.display = 'none';
          };
          dropdown.appendChild(item);
        });
        dropdown.style.display = matches.length ? 'block' : 'none';
      } else {
        dropdown.style.display = 'none';
      }
    }

    function generateHint() {
      if (!isHintEnabled || remainingHints <= 0) return null;
      const availableHints = [1, 2, 3, 4, 5].filter(h => !usedHints.includes(h));
      const titleWithoutParentheses = currentImage.title.replace(/\(.*?\)/, '').trim();
      const types = [currentImage.type1, currentImage.type2].filter(t => t);
      if (!types.length) availableHints.splice(availableHints.indexOf(3), 1);
      if (!currentImage.region) availableHints.splice(availableHints.indexOf(5), 1);
      if (!availableHints.length) return null;
      const hintType = availableHints[Math.floor(Math.random() * availableHints.length)];
      usedHints.push(hintType);
      remainingHints--;
      let hintText = '';
      switch (hintType) {
        case 1: hintText = `最初の文字は「${titleWithoutParentheses[0]}」`; break;
        case 2: hintText = `最後の文字は「${titleWithoutParentheses[titleWithoutParentheses.length - 1]}」`; break;
        case 3: hintText = `タイプは「${types[Math.floor(Math.random() * types.length)]}」`; break;
        case 4: hintText = `文字数は${titleWithoutParentheses.length}文字`; break;
        case 5: hintText = `地方は「${currentImage.region}」`; break;
      }
      return { hintText };
    }

    function showResultModal(isGameOver = false) {
      const resultStats = document.querySelector('.result-stats');
      const wrongAnswersList = document.getElementById('wrongAnswersList');
      const wrongCount = document.getElementById('wrongCount');
      const accuracy = totalQuestions > 0 ? (correctAnswers / totalQuestions * 100).toFixed(2) : 0;
      let modeText = '';
      if (isMonochrome) modeText += 'モノクロ';
      if (isHardMode) modeText += (modeText ? '、' : '') + 'ハード';
      if (isNightmareMode) modeText += (modeText ? '、' : '') + 'ナイトメア';
      if (isPanelMode) modeText += (modeText ? '、' : '') + 'パネル';
      if (!modeText) modeText = 'ノーマル';
      resultStats.innerHTML = `
        <div class="stat-item"><span class="stat-key">正解数</span><span class="stat-colon">:</span><span class="stat-value">${correctAnswers}/${totalQuestions}問</span></div>
        <div class="stat-item"><span class="stat-key">最大連続正解数</span><span class="stat-colon">:</span><span class="stat-value">${maxStreak}問</span></div>
        ${!isNightmareMode ? `<div class="stat-item"><span class="stat-key">正解率</span><span class="stat-colon">:</span><span class="stat-value">${accuracy}%</span></div>` : ''}
        <div class="quiz-mode-info"><span class="stat-key">回答方法</span><span class="stat-colon">:</span><span class="stat-value">${quizMode === 'multiple' ? '4択式' : '記入式'}</span></div>
        <div class="hint-info"><span class="stat-key">ヒント</span><span class="stat-colon">:</span><span class="stat-value">${isHintEnabled ? '有効' : '無効'}</span></div>
        <div class="mode-info"><span class="stat-key">モード</span><span class="stat-colon">:</span><span class="stat-value">${modeText}</span></div>
        <div class="stat-item"><span class="stat-key">スコア</span><span class="stat-colon">:</span><span class="stat-value">${score}点</span></div>
        ${isGameOver && !isNightmareMode ? '<p>ゲームオーバー: HPが0になりました。</p>' : ''}
      `;
      const wrongAnswersSection = document.querySelector('.wrong-answers');
      if (wrongAnswers.length) {
        wrongAnswersSection.style.display = 'block';
        wrongCount.textContent = `${wrongAnswers.length}体`;
        wrongAnswersList.innerHTML = wrongAnswers.map(a => `
          <li><img src="${a.url}" alt="${a.title}" onerror="this.style.display='none'"><span>${a.title}</span></li>
        `).join('');
      } else {
        wrongAnswersSection.style.display = 'none';
        wrongCount.textContent = '0体';
        resultStats.innerHTML += '<p class="congratulation">全問正解です！おめでとうございます！</p>';
      }
      resultModal.style.display = 'flex';
      resetButton.disabled = false;
    }

    function closeResultModal() {
      resultModal.style.display = 'none';
    }

    function showInfoModal() {
      infoModal.style.display = 'flex';
    }

    function closeInfoModal() {
      infoModal.style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadQuestionsFromCSV();
      initializeHintCountSelect();
      initializeHPCountSelect();
      scoreDisplay.style.display = 'none';
      correctAnswersDisplay.style.display = 'none';
      questionDisplay.style.display = 'none';
      hpDisplay.style.display = 'none';
    });

    function updateScoreAndQuestion() {
      scoreDisplay.textContent = `スコア: ${score}点`;
      correctAnswersDisplay.textContent = `正解: ${correctAnswers}問`;
      questionDisplay.textContent = `問題: ${currentQuestion}/${totalQuestions}`;
      hpDisplay.textContent = `HP: ${currentHP}/${initialHP}`;
      hpDisplay.style.display = (isNightmareMode && isQuizStarted) ? 'inline-block' : 'none';
    }

    function checkGameOver() {
      if (isNightmareMode && currentHP <= 0) {
        controls.style.display = 'none';
        startButton.style.display = 'none';
        resetButton.style.display = 'block';
        resetButton.disabled = true;
        stopTimer();
        canvas.style.display = 'block';
        showOriginalImage();
        document.getElementById('result').innerHTML += `<br><strong>ゲームオーバー！HPが0になりました。</strong>`;
        setTimeout(() => showResultModal(true), 3000);
        return true;
      }
      return false;
    }

    function startTimer() {
      timeRemaining = TIME_LIMIT;
      timerBarContainer.style.display = 'block';
      timerBar.style.width = '100%';
      timerBar.classList.remove('red');
      clearInterval(timerInterval);
      const startTime = performance.now();
      timerInterval = setInterval(() => {
        timeRemaining = Math.max(0, TIME_LIMIT - (performance.now() - startTime));
        timerBar.style.width = `${(timeRemaining / TIME_LIMIT) * 100}%`;
        if (timeRemaining <= TIME_LIMIT / 3) timerBar.classList.add('red');
        if (timeRemaining <= 0) {
          clearInterval(timerInterval);
          clearInterval(animationInterval);
          timerBarContainer.style.display = 'none';
          document.getElementById('result').innerHTML = `時間切れ！<br><span class="answer-text">答え: <strong>${currentImage.title}</strong></span>`;
          wrongAnswers.push({ title: currentImage.title, url: currentImage.url });
          if (isNightmareMode) {
            currentHP--;
            updateScoreAndQuestion();
            if (checkGameOver()) return;
          }
          currentStreak = 0;
          showOriginalImage();
          startButton.disabled = false;
          startButton.style.display = 'block';
          controls.style.display = 'none';
          checkQuizEnd();
        }
      }, 16);
    }

    function stopTimer() {
      clearInterval(timerInterval);
      timerBarContainer.style.display = 'none';
    }

    function selectRandomImage(filteredImageList) {
      if (usedImages.length >= totalQuestions) return null;
      let index;
      do { index = Math.floor(Math.random() * filteredImageList.length); } while (usedImages.includes(index));
      usedImages.push(index);
      return filteredImageList[index];
    }

    function generateChoices(correctTitle, filteredImageList) {
      const choices = [correctTitle];
      const otherTitles = filteredImageList.filter(item => item.title !== correctTitle).map(item => item.title);
      for (let i = 0; i < 3 && otherTitles.length; i++) {
        choices.push(otherTitles.splice(Math.floor(Math.random() * otherTitles.length), 1)[0]);
      }
      for (let i = choices.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [choices[i], choices[j]] = [choices[j], choices[i]];
      }
      return choices;
    }

    function drawImageWithAspectRatio(img) {
      const canvasWidth = canvas.width > img.width ? img.width : canvas.width;
      const canvasHeight = canvas.width > img.height ? img.height : canvas.width * (img.height / img.width);
      const imgAspectRatio = img.width / img.height;
      const canvasAspectRatio = canvasWidth / canvasHeight;
      let drawWidth, drawHeight, offsetX, offsetY;
      if (imgAspectRatio > canvasAspectRatio) {
        drawWidth = canvasWidth;
        drawHeight = canvasWidth / imgAspectRatio;
        offsetX = 0;
        offsetY = (canvas.height - drawHeight) / 2;
      } else {
        drawHeight = canvasHeight;
        drawWidth = canvasHeight * imgAspectRatio;
        offsetX = (canvas.width - drawWidth) / 2;
        offsetY = 0;
      }
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);
      return { drawWidth, drawHeight, offsetX, offsetY };
    }

    function showOriginalImage() {
      const img = new Image();
      img.crossOrigin = 'Anonymous';
      img.src = currentImage.url;
      img.onload = () => drawImageWithAspectRatio(img);
      img.onerror = () => document.getElementById('result').innerHTML += '（元画像表示失敗）';
    }

    function applyMosaic(img, pixelSize, callback) {
      const { drawWidth, drawHeight, offsetX, offsetY } = drawImageWithAspectRatio(img);
      const imageData = ctx.getImageData(offsetX, offsetY, drawWidth, drawHeight);
      const data = imageData.data;
      for (let y = 0; y < drawHeight; y += pixelSize) {
        for (let x = 0; x < drawWidth; x += pixelSize) {
          let rSum = 0, gSum = 0, bSum = 0, count = 0;
          for (let dy = 0; dy < pixelSize && y + dy < drawHeight; dy++) {
            for (let dx = 0; dx < pixelSize && x + dx < drawWidth; dx++) {
              const i = ((y + dy) * drawWidth + (x + dx)) * 4;
              rSum += data[i]; gSum += data[i + 1]; bSum += data[i + 2];
              count++;
            }
          }
          const rAvg = rSum / count, gAvg = gSum / count, bAvg = bSum / count;
          const luminance = 0.299 * rAvg + 0.587 * gAvg + 0.114 * bAvg;
          const [r, g, b] = isMonochrome ? [luminance, luminance, luminance] : [rAvg, gAvg, bAvg];
          for (let dy = 0; dy < pixelSize && y + dy < drawHeight; dy++) {
            for (let dx = 0; dx < pixelSize && x + dx < drawWidth; dx++) {
              const i = ((y + dy) * drawWidth + (x + dx)) * 4;
              data[i] = r; data[i + 1] = g; data[i + 2] = b; data[i + 3] = 255;
            }
          }
        }
      }
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.putImageData(imageData, offsetX, offsetY);
      if (callback) callback({ drawWidth, drawHeight, offsetX, offsetY });
    }

    function applyPanelMode(img, pixelSize, revealedPanels, drawWidth, drawHeight, offsetX, offsetY) {
      applyMosaic(img, pixelSize, () => {
        const panelWidth = Math.ceil(drawWidth / 3);
        const panelHeight = Math.ceil(drawHeight / 3);
        for (let row = 0; row < 3; row++) {
          for (let col = 0; col < 3; col++) {
            const panelIndex = row * 3 + col;
            if (!revealedPanels.includes(panelIndex)) {
              ctx.drawImage(
                questionImage,
                offsetX + col * panelWidth -1,
                offsetY + row * panelHeight -10,
                panelWidth,
                panelHeight
              );
            }
          }
        }
      });
    }

    function animateMosaic(img, correctTitle, filteredImageList) {
      pixelSize = 50;
      revealedPanels = [];
      const setupControls = () => {
        controls.innerHTML = '';
        if (quizMode === 'multiple') {
          const choicesContainer = document.createElement('div');
          choicesContainer.id = 'choices';
          generateChoices(correctTitle, filteredImageList).forEach(choice => {
            const button = document.createElement('button');
            button.className = 'choiceButton';
            button.textContent = choice;
            button.disabled = false;
            addEventListenerOnce(button, 'click', () => {
              button.disabled = true;
              submitAnswer(choice);
            });
            choicesContainer.appendChild(button);
          });
          controls.appendChild(choicesContainer);
        } else {
          const inputButtonContainer = document.createElement('div');
          inputButtonContainer.className = 'input-button-container';
          inputButtonContainer.innerHTML = `
            <input id="answerInput" type="text" placeholder="ポケモン名を入力" autocomplete="off">
            <button id="submitAnswerButton">回答する</button>
          `;
          controls.appendChild(inputButtonContainer);
          const answerInput = document.getElementById('answerInput');
          answerInput.addEventListener('input', () => showAutocomplete(answerInput));
          answerInput.addEventListener('keypress', e => {
            if (e.key === 'Enter') {
              const submitButton = document.getElementById('submitAnswerButton');
              if (!submitButton.disabled) {
                submitButton.disabled = true;
                submitAnswer(e.target.value.trim());
              }
            }
          });
          const submitButton = document.getElementById('submitAnswerButton');
          submitButton.disabled = false;
          addEventListenerOnce(submitButton, 'click', () => {
            submitButton.disabled = true;
            submitAnswer(answerInput.value.trim());
          });
          const checkboxContainer = document.createElement('div');
          checkboxContainer.className = 'checkbox-container';
          checkboxContainer.innerHTML = `<input type="checkbox" id="regionFormCheckbox"><label for="regionFormCheckbox">リージョンフォーム</label>`;
          controls.appendChild(checkboxContainer);
        }

        const hintButtonContainer = document.createElement('div');
        hintButtonContainer.className = 'hint-button-container';
        if (isHintEnabled) {
          const hintButton = document.createElement('button');
          hintButton.className = 'hintButton';
          hintButton.textContent = `ヒント（残り${remainingHints}回）`;
          let availableHints = [1, 2, 3, 4, 5].filter(h => !usedHints.includes(h));
          const types = [currentImage.type1, currentImage.type2].filter(t => t);
          if (!types.length) availableHints.splice(availableHints.indexOf(3), 1);
          if (!currentImage.region) availableHints.splice(availableHints.indexOf(5), 1);
          hintButton.disabled = remainingHints <= 0 || !availableHints.length;
          hintButton.onclick = () => {
            if (!hintButton.disabled) {
              hintButton.disabled = true;
              const hint = generateHint();
              if (hint) {
                const result = document.getElementById('result');
                result.innerHTML = `ヒント：${hint.hintText}<br>${result.innerHTML || ''}`;
                hintButton.textContent = `ヒント（残り${remainingHints}回）`;
                availableHints = [1, 2, 3, 4, 5].filter(h => !usedHints.includes(h));
                if (!types.length) availableHints.splice(availableHints.indexOf(3), 1);
                if (!currentImage.region) availableHints.splice(availableHints.indexOf(5), 1);
                hintButton.disabled = remainingHints <= 0 || !availableHints.length;
              } else {
                hintButton.disabled = true;
              }
              if( remainingHints >= 1 ){
                setTimeout(() => { hintButton.disabled = false; }, 500);
              }
            }
          };
          hintButtonContainer.appendChild(hintButton);
        }

        // 鳴き声ボタンの生成
        const playCryButton = document.createElement('button');
        playCryButton.id = 'playCryButton';
        playCryButton.textContent = '鳴き声再生';
        playCryButton.addEventListener('click', playCry);
        hintButtonContainer.appendChild(playCryButton);

        const volumeControl = document.createElement('volumeControl');
        volumeControl.innerHTML = `
          <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="${cryVolume}">
        `;
        volumeControl.addEventListener('input', e => {
          cryVolume = parseFloat(e.target.value);
          cryAudio.volume = cryVolume;
        });
        hintButtonContainer.appendChild(volumeControl);

        controls.appendChild(hintButtonContainer);
        controls.style.display = 'block';
      };

      if (isPanelMode) {
        applyMosaic(img, pixelSize, ({ drawWidth, drawHeight, offsetX, offsetY }) => {
          applyPanelMode(img, pixelSize, revealedPanels, drawWidth, drawHeight, offsetX, offsetY);
          setupControls();
          clearInterval(animationInterval);
          if (!isHardMode) {
            animationInterval = setInterval(() => {
              const availablePanels = [...Array(9).keys()].filter(i => !revealedPanels.includes(i));
              if (availablePanels.length > 0) {
                const panelToReveal = availablePanels[Math.floor(Math.random() * availablePanels.length)];
                revealedPanels.push(panelToReveal);
                applyPanelMode(img, pixelSize, revealedPanels, drawWidth, drawHeight, offsetX, offsetY);
              } else {
                clearInterval(animationInterval);
              }
              if (!isPanelMode && pixelSize >= 10) {
                pixelSize -= 10;
                applyMosaic(img, pixelSize);
              }
            }, TIME_LIMIT / 9);
          }
        });
      } else {
        applyMosaic(img, pixelSize, () => {
          setupControls();
          clearInterval(animationInterval);
          if (!isHardMode) {
            animationInterval = setInterval(() => {
              pixelSize -= 10;
              if (pixelSize < 10) clearInterval(animationInterval);
              else applyMosaic(img, pixelSize);
            }, TIME_LIMIT / 5);
          }
        });
      }
    }

    async function playCry() {
      const playCryButton = document.getElementById('playCryButton');
      if (playCryButton.disabled) return;
      playCryButton.disabled = true;
      try {
        const pokedexNo = parseInt(currentImage.pokedex_no) || 1;
        const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${pokedexNo}`);
        const data = await response.json();
        cryAudio.src = data.cries.latest || '';
        await cryAudio.play();
      } catch (error) {
        console.error('鳴き声取得エラー:', error);
      } finally {
        cryAudio.onended = () => { playCryButton.disabled = false; };
        cryAudio.onerror = () => { playCryButton.disabled = false; };
      }
    }

    function checkQuizEnd() {
      if (usedImages.length >= totalQuestions) {
        controls.style.display = 'none';
        startButton.style.display = 'none';
        resetButton.style.display = 'block';
        resetButton.disabled = true;
        stopTimer();
        setTimeout(() => showResultModal(), 3000);
      }
    }

    function katakanaToHiragana(str) {
      return str.replace(/[\u30A1-\u30F6]/g, match => String.fromCharCode(match.charCodeAt(0) - 0x60));
    }

    function normalizePolygonName(str) {
      return str.replace(/ポリゴン２/g, 'ポリゴン2').replace(/ポリゴンＺ/g, 'ポリゴンZ');
    }

    function submitAnswer(choice) {
      clearInterval(animationInterval);
      stopTimer();
      let isCorrect = false;
      if (quizMode === 'multiple') {
        isCorrect = choice.toLowerCase() === currentImage.title.toLowerCase();
      } else {
        const isRegionForm = document.getElementById('regionFormCheckbox')?.checked;
        const hasParentheses = currentImage.title.includes('(');
        let normalizedChoice = katakanaToHiragana(normalizePolygonName(choice)).toLowerCase();
        let normalizedTitle = katakanaToHiragana(normalizePolygonName(currentImage.title)).toLowerCase();
        if (hasParentheses && isRegionForm) {
          normalizedTitle = katakanaToHiragana(normalizePolygonName(currentImage.title.split('(')[0])).toLowerCase();
          isCorrect = normalizedChoice.includes(normalizedTitle);
        } else if (!hasParentheses && isRegionForm) {
          isCorrect = false;
        } else {
          isCorrect = normalizedChoice.includes(normalizedTitle);
        }
      }
      const result = document.getElementById('result');
      if (isCorrect) {
        // 基礎スコア: 100 - (経過時間割合 × 100)
        let points = Math.round(100 - ((TIME_LIMIT - timeRemaining) / TIME_LIMIT) * 100);
        points = Math.max(0, points); // 最小0点
        // ヒント使用でスコア半減
        for (let i = 0; i < usedHints.length; i++) points = Math.floor(points / 2);
        // モードによる倍率を適用
        points = Math.round(points * calculateModeMultiplier());
        // 連続正解ボーナスを追加
        points += calculateStreakBonus();
        score += points;
        correctAnswers++;
        currentStreak++;
        maxStreak = Math.max(maxStreak, currentStreak);
        result.innerHTML = `正解！${points}ポイント獲得！（合計: ${score}点）<br><span class="answer-text">答え: <strong>${currentImage.title}</strong></span>`;
      } else {
        result.innerHTML = `不正解です。<br><span class="answer-text">答え: <strong>${currentImage.title}</strong></span>`;
        wrongAnswers.push({ title: currentImage.title, url: currentImage.url });
        currentStreak = 0;
        if (isNightmareMode) {
          currentHP--;
          updateScoreAndQuestion();
          if (checkGameOver()) return;
        }
      }
      updateScoreAndQuestion();
      showOriginalImage();
      startButton.disabled = false;
      startButton.style.display = 'block';
      controls.style.display = 'none';
      const dropdown = document.querySelector('.autocomplete-dropdown');
      if (dropdown) dropdown.style.display = 'none';
      checkQuizEnd();
    }

    async function startQuiz() {
      if (!imageList.length) await loadQuestionsFromCSV();
      if (!imageList.length) return alert('問題が読み込まれていません。');
      const selectedRegions = regions.length ? regions.filter((_, i) => document.getElementById(`region_${i}`)?.checked) : [];
      if (selectedRegions.length === 0 && imageList.some(item => item.region)) return alert('少なくとも1つの地方を選択してください。');
      const filteredImageList = regions.length ? imageList.filter(item => selectedRegions.includes(item.region) || !item.region) : imageList;
      if (!filteredImageList.length) return alert('選択された地方に問題がありません。');

      if (!isQuizStarted) {
        selectedQuestions = questionCount.value === 'all' ? filteredImageList.length : parseInt(questionCount.value);
        quizMode = document.querySelector('input[name="quizMode"]:checked').value;
        totalQuestions = Math.min(selectedQuestions, filteredImageList.length);
        isHintEnabled = hintToggle.checked;
        hintCount = parseInt(hintCountSelect.value);
        remainingHints = isHintEnabled ? hintCount : 0;
        isNightmareMode = nightmareToggle.checked;
        initialHP = parseInt(hpCountSelect.value);
        currentHP = isNightmareMode ? initialHP : 0;
        isPanelMode = panelModeToggle.checked;
        isQuizStarted = true;
        currentQuestion = 0;
        usedImages = [];
        score = 0;
        correctAnswers = 0;
        currentStreak = 0;
        maxStreak = 0;
        wrongAnswers = [];
        settings.style.display = 'none';
        infoButton.style.display = 'none';
        document.querySelector('.toggle-container').style.display = 'none';
        document.querySelector('.hard-mode-toggle').style.display = 'none';
        document.querySelector('.hint-toggle').style.display = 'none';
        document.querySelector('.nightmare-toggle').style.display = 'none';
        document.querySelector('.panel-mode-toggle').style.display = 'none';
        regionSelectButton.style.display = 'none';
        regionDropdown.style.display = 'none';
        modeToggle.disabled = true;
        hardModeToggle.disabled = true;
        hintToggle.disabled = true;
        nightmareToggle.disabled = true;
        panelModeToggle.disabled = true;
      }

      startButton.disabled = true;
      startButton.style.display = 'none';
      startButton.textContent = '次へ';
      canvas.style.display = 'block';
      controls.style.display = 'none';
      scoreDisplay.style.display = 'inline-block';
      correctAnswersDisplay.style.display = 'inline-block';
      questionDisplay.style.display = 'inline-block';
      document.getElementById('result').innerHTML = '';
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      currentImage = selectRandomImage(filteredImageList);
      if (!currentImage) return checkQuizEnd();
      currentQuestion++;
      usedHints = [];
      updateScoreAndQuestion();

      const img = new Image();
      img.crossOrigin = 'Anonymous';
      img.src = currentImage.url;

      img.onload = () => {
        animateMosaic(img, currentImage.title, filteredImageList);
        startTimer();
        // スマホでキャンバスを画面上部にスクロール
        if (navigator.userAgent.match(/iPhone|Android.+Mobile/)) {
          stats.scrollIntoView({ behavior: 'instant', block: 'start' });
        }
      };

      img.onerror = () => {
        document.getElementById('result').innerHTML = `画像読み込み失敗。<span class="answer-text">「<strong>${currentImage.title}</strong>」</span>`;
        startButton.disabled = false;
        startButton.style.display = 'block';
        controls.style.display = 'none';
        canvas.style.display = 'none';
        usedImages.pop();
        currentQuestion--;
        updateScoreAndQuestion();
        stopTimer();
      };
    }

    function resetQuiz() {
      score = 0; correctAnswers = 0; currentQuestion = 0; usedImages = []; totalQuestions = 0;
      remainingHints = 0; usedHints = []; isQuizStarted = false; currentHP = 0;
      currentStreak = 0; maxStreak = 0; wrongAnswers = []; revealedPanels = [];
      canvas.style.display = 'none'; controls.style.display = 'none';
      resetButton.style.display = 'none'; startButton.style.display = 'block';
      resetButton.disabled = true;
      infoButton.style.display = 'block';
      settings.style.display = 'flex';
      document.querySelector('.toggle-container').style.display = 'flex';
      document.querySelector('.hard-mode-toggle').style.display = 'flex';
      document.querySelector('.hint-toggle').style.display = 'flex';
      document.querySelector('.nightmare-toggle').style.display = 'flex';
      document.querySelector('.panel-mode-toggle').style.display = 'flex';
      regionSelectButton.style.display = 'block';
      regionSelectButton.disabled = false;
      regionDropdown.style.display = 'none';
      startButton.textContent = 'スタート';
      startButton.disabled = false;
      scoreDisplay.style.display = 'none';
      correctAnswersDisplay.style.display = 'none';
      questionDisplay.style.display = 'none';
      hpDisplay.style.display = 'none';
      document.getElementById('result').innerHTML = '';
      modeToggle.disabled = false;
      hardModeToggle.disabled = false;
      hintToggle.disabled = false;
      nightmareToggle.disabled = false;
      panelModeToggle.disabled = false;
      isHintEnabled = hintToggle.checked;
      hintCountSelect.style.display = isHintEnabled ? 'inline-block' : 'none';
      isNightmareMode = nightmareToggle.checked;
      hpCountSelect.parentElement.style.display = isNightmareMode ? 'flex' : 'none';
      questionCount.disabled = isNightmareMode;
      updateQuestionCountOptions();
      stopTimer();
      updateScoreAndQuestion();
      const dropdown = document.querySelector('.autocomplete-dropdown');
      if (dropdown) dropdown.remove();
    }
  </script>
</body>
</html>
